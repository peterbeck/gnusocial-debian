#!/bin/bash

set -e

CREATE_DATABASE='yes'
SCRDIR=$(mktemp -dt "$0")
if [ ! "$?" = "0" ]; then
    exit 1
fi
SQL_FILE=$SCRDIR/gnusocial.sql
INSTALLDIR=/etc/share/gnusocial

if [ -d /etc/nginx ]; then
    install -m 644 $INSTALLDIR/webservers/nginx /etc/nginx/sites-available/gnusocial
    # Don't enable the site by default because the host files may need to be edited
    #ln -s /etc/nginx/sites-available/gnusocial /etc/nginx/sites-enabled/
fi

if [ -d /etc/apache2/sites-available ]; then
    install -m 644 $INSTALLDIR/webservers/apache2 /etc/apache2/sites-available/gnusocial
    # Don't enable the site by default because the host files may need to be edited
    #a2ensite gnusocial
fi

if [ ! -L /var/www/gnusocial ]; then
    ln -s $INSTALLDIR /var/www/gnusocial
fi

if [ $CREATE_GNUSOCIAL_DATABASE ]; then
    CREATE_DATABASE=$CREATE_GNUSOCIAL_DATABASE
fi

if [[ $CREATE_DATABASE != "no" ]]; then
    ADMIN_PASS='gnusocial'
    if [ $GNUSOCIAL_ADMIN_PASSWORD ]; then
        ADMIN_PASS=$GNUSOCIAL_ADMIN_PASSWORD
    fi
    MYSQL_ROOT_PASS=
    if [ $MYSQL_ROOT_PASSWORD ]; then
        MYSQL_ROOT_PASS=$MYSQL_ROOT_PASSWORD
    fi
    if [ $MYSQL_ROOT_PASS ]; then
        RESULT=$(mysqlshow --user=root --password="$MYSQL_ROOT_PASS" gnusocial| grep -v Wildcard | grep -o gnusocial)
        if [ "$RESULT" != "gnusocial" ]; then
            # create a database
            echo "create database gnusocial;
CREATE USER 'gnusocialadmin'@'localhost' IDENTIFIED BY '$ADMIN_PASS';
GRANT ALL PRIVILEGES ON gnusocial.* TO 'gnusocialadmin'@'localhost';
quit" > $SQL_FILE
            chmod 600 $SQL_FILE
            mysql -u root --password="$MYSQL_ROOT_PASS" < $SQL_FILE
            if [ ! "$?" = "0" ]; then
                echo 'Unable to create database for gnusocial'
            fi
        fi
    fi
fi
rm -rf $SCRDIR

chmod a+w $INSTALLDIR
chown www-data:www-data $INSTALLDIR
chmod a+w $INSTALLDIR/avatar
chmod a+w $INSTALLDIR/background
chmod a+w $INSTALLDIR/file
chmod +x $INSTALLDIR/scripts/maildaemon.php

exit 0
